<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bittrade.entrust.dao.ITEntrustDAO">

	<!-- 通用查询映射结果 -->
	<resultMap id="BaseResultMap" type="com.bittrade.pojo.model.TEntrust">
		<id javaType="int" property="id" jdbcType="INTEGER" column="id" />
		<result javaType="long" property="userId" jdbcType="BIGINT" column="user_id" />
		<result javaType="int" property="currencyTradeId" jdbcType="INTEGER" column="currency_trade_id" />
		<result javaType="java.math.BigDecimal" property="price" jdbcType="DECIMAL" column="price" />
		<result javaType="java.math.BigDecimal" property="amount" jdbcType="DECIMAL" column="amount" />
		<result javaType="java.math.BigDecimal" property="successAmount" jdbcType="DECIMAL" column="success_amount" />
		<result javaType="java.math.BigDecimal" property="count" jdbcType="DECIMAL" column="count" />
		<result javaType="java.math.BigDecimal" property="leftCount" jdbcType="DECIMAL" column="left_count" />
		<result javaType="java.math.BigDecimal" property="fees" jdbcType="DECIMAL" column="fees" />
		<result javaType="java.math.BigDecimal" property="leftFees" jdbcType="DECIMAL" column="left_fees" />
		<result javaType="int" property="status" jdbcType="INTEGER" column="status" />
		<result javaType="int" property="entrustType" jdbcType="INTEGER" column="entrust_type" />
		<result javaType="int" property="entrustDirection" jdbcType="INTEGER" column="entrust_direction" />
		<result javaType="int" property="version" jdbcType="INTEGER" column="version" />
		<result javaType="java.time.LocalDateTime" property="createTime" jdbcType="TIMESTAMP" column="create_time" />
		<result javaType="java.time.LocalDateTime" property="updateTime" jdbcType="TIMESTAMP" column="update_time" />
	</resultMap>

	<!-- 通用查询结果列 -->
	<sql id="Base_Column_List">
		`user_id` AS userId, 
		`currency_trade_id` AS currencyTradeId, 
		`price` AS price, 
		`amount` AS amount, 
		`success_amount` AS successAmount, 
		`count` AS count, 
		`left_count` AS leftCount, 
		`fees` AS fees, 
		`left_fees` AS leftFees, 
		`status` AS status, 
		`entrust_type` AS entrustType, 
		`entrust_direction` AS entrustDirection, 
		`version` AS version, 
		`create_time` AS createTime, 
		`update_time` AS updateTime
	</sql>

	<!-- 查询用户的委托单成交明细	-->
	<select id="queryEntrustInfoByUserId" resultType="com.bittrade.pojo.vo.TEntrustInfoVO">
		SELECT e.create_time as  entrustTime,IFNULL(c1.name,c2.name) as currencyName,e.count,e.left_count as leftCount,
			   e.status,e.entrust_direction as entrustDirection,e.amount,e.price,e.entrust_type as entrustType
		FROM t_entrust e
		INNER JOIN t_currency_trade t ON e.currency_trade_id = t.id
		LEFT JOIN t_currency c1 ON t.currency_id1 = c1.id
		LEFT JOIN t_currency c2 ON t.currency_id2 = c2.id
		WHERE e.user_id = #{userId}
		AND e.id = #{entrustId}
	</select>

	<!-- 撤单	-->
	<update id="killOrder" parameterType="com.bittrade.pojo.model.TEntrust">
		UPDATE t_entrust
		SET status = #{status},version = version + 1
		WHERE id = #{id} AND version = #{version}
	</update>
	
	<update id="updateOnMatch">
		UPDATE t_entrust
		SET 
			success_amount = #{successAmount}, 
			left_count = #{leftCount}, 
			status = #{status}, 
			version = version + 1, 
			update_time = #{updateTime}
		WHERE id = #{ID} AND version = #{version}
	</update>
	
	<select id="testByPage" resultMap="com.bittrade.__default.DAO.IDefaultTEntrustDAO.BaseResultMap">
	  SELECT id, user_id, currency_trade_id
	  FROM t_entrust
	  <where>
	    AND entrust_type = #{entrust.entrustType}
	  </where>
	  ORDER BY ID ASC
	</select>
	
	<select id="testByDTO" resultMap="com.bittrade.__default.DAO.IDefaultTEntrustDAO.BaseResultMap">
	  SELECT id, user_id, currency_trade_id
	  FROM t_entrust
	  <where>
		  <include refid="com.bittrade.__default.DAO.IDefaultTEntrustDAO.sql_WHERE_forProperty"></include>
	  </where>
	</select>

</mapper>