<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bittrade.c2c.dao.ITAdvertOrderDAO">

	<!-- 通用查询映射结果 -->
	<resultMap id="BaseResultMap" type="com.bittrade.pojo.model.TAdvertOrder">
		<id javaType="int" property="id" jdbcType="INTEGER" column="id" />
		<result javaType="Long" property="advertId" jdbcType="BIGINT" column="advert_id" />
		<result javaType="Long" property="coinId" jdbcType="BIGINT" column="coin_id" />
		<result javaType="String" property="orderNumber" jdbcType="VARCHAR" column="order_number" />
		<result javaType="String" property="paymentLegalCurrency" jdbcType="VARCHAR" column="payment_legal_currency" />
		<result javaType="Byte" property="advertType" jdbcType="INTEGER" column="advert_type" />
		<result javaType="String" property="advertMessage" jdbcType="VARCHAR" column="advert_message" />
		<result javaType="Long" property="buyerId" jdbcType="BIGINT" column="buyer_id" />
		<result javaType="Long" property="sellerId" jdbcType="BIGINT" column="seller_id" />
		<result javaType="Long" property="publisherId" jdbcType="BIGINT" column="publisher_id" />
		<result javaType="Long" property="cancellerId" jdbcType="BIGINT" column="canceller_id" />
		<result javaType="java.math.BigDecimal" property="transactionAmout" jdbcType="DECIMAL" column="transaction_amout" />
		<result javaType="java.math.BigDecimal" property="transactionNum" jdbcType="DECIMAL" column="transaction_num" />
		<result javaType="java.math.BigDecimal" property="transactionPrice" jdbcType="DECIMAL" column="transaction_price" />
		<result javaType="java.math.BigDecimal" property="rate" jdbcType="DECIMAL" column="rate" />
		<result javaType="java.math.BigDecimal" property="charge" jdbcType="DECIMAL" column="charge" />
		<result javaType="Byte" property="status" jdbcType="INTEGER" column="status" />
		<result javaType="java.time.LocalDateTime" property="cancelOrderDeadline" jdbcType="TIMESTAMP" column="cancel_order_deadline" />
		<result javaType="Byte" property="arbitStatus" jdbcType="INTEGER" column="arbit_status" />
		<result javaType="String" property="arbitResult" jdbcType="VARCHAR" column="arbit_result" />
		<result javaType="java.time.LocalDateTime" property="paymentTime" jdbcType="TIMESTAMP" column="payment_time" />
		<result javaType="java.time.LocalDateTime" property="grantCoinTime" jdbcType="TIMESTAMP" column="grant_coin_time" />
		<result javaType="java.time.LocalDateTime" property="overdueTime" jdbcType="TIMESTAMP" column="overdue_time" />
		<result javaType="String" property="remark" jdbcType="VARCHAR" column="remark" />
		<result javaType="java.time.LocalDateTime" property="createTime" jdbcType="TIMESTAMP" column="create_time" />
		<result javaType="java.time.LocalDateTime" property="updateTime" jdbcType="TIMESTAMP" column="update_time" />
	</resultMap>

	<!-- 通用查询结果列 -->
	<sql id="Base_Column_List">
		`id` AS id,
		`advert_id` AS advertId,
		`coin_id` AS coinId,
		`order_number` AS orderNumber,
		`payment_legal_currency` AS paymentLegalCurrency,
		`advert_type` AS advertType,
		`advert_message` AS advertMessage,
		`buyer_id` AS buyerId,
		`seller_id` AS sellerId,
		`publisher_id` AS publisherId,
		`canceller_id` AS cancellerId,
		`transaction_amout` AS transactionAmout,
		`transaction_num` AS transactionNum,
		`transaction_price` AS transactionPrice,
		`rate` AS rate,
		`charge` AS charge,
		`status` AS status,
		`cancel_order_deadline` AS cancelOrderDeadline,
		`arbit_status` AS arbitStatus,
		`arbit_result` AS arbitResult,
		`payment_time` AS paymentTime,
		`grant_coin_time` AS grantCoinTime,
		`overdue_time` AS overdueTime,
		`remark` AS remark,
		`create_time` AS createTime,
		`update_time` AS updateTime
	</sql>

    <select id="getPaymentOrPutCoinAging" resultType="java.lang.Long">
		SELECT
			<if test="type == 1">
				IFNULL(
					ROUND(
						AVG(
						TIMESTAMPDIFF(SECOND, ao.`create_time`, ao.`grant_coin_time`)
						),
					0),
				0)
			</if>
			 <if test="type == 2">
				 IFNULL(
				 	ROUND(
						 AVG(
						 TIMESTAMPDIFF(SECOND, ao.`create_time`, ao.`payment_time`)
						 ),
				 	0),
				 0)
			 </if>
		FROM
		  `t_advert_order` AS ao
		  <where>
			  <if test="type == 1">
				  AND ao.`seller_id` = #{userId}
			  </if>
			  <if test="type == 2">
				  AND ao.`buyer_id` = #{userId}
			  </if>
			  AND ao.`advert_type` = #{type}
			  AND ao.`status` = #{status};
		  </where>
	</select>

    <select id="listAdvertOrders" resultType="com.bittrade.pojo.model.TAdvertOrder">
		select
		  ao.*,
		  lcc.`name` as coinName
		from
		  `t_advert_order` as ao
		  inner join `t_legal_currency_coin` as lcc
			on ao.`coin_id` = lcc.`id`
		where (
			ao.`buyer_id` = #{userId}
			or ao.`seller_id` = #{userId}
		  )
		  and ao.`status` = #{status}
	</select>

</mapper>