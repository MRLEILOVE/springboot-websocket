<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<meta charset="utf-8">
<style>
.banner-box{
	width:350px;
	height:150px;
	border:1px solid #e5e6e7;
	background:url(../../img/banner-add.png) no-repeat center;
	background-size:45px 45px;
    position: relative;
    box-sizing: content-box;
}
.downloadPic{
	width:100%;
	height:100%;
    opacity: 0;
    position: absolute;
    top:0;
    left:0;
    z-index:2;
}
.banner-img{
	position: absolute;
	width:100%;
	height:100%;
	top:0;
    left:0;
    z-index:1;
}
.add-img{
	position: absolute;
	width:24px;
	height:24px;
	line-height:24px;
	text-align:center;
	left:0;
	bottom:0;
	top:0;
	right:0;
	margin:auto;
	font-size:32px;
	z-index:0;
}
.banner-size{
	float: right !important;
	margin-top: -15px;
}
</style>
<head th:include="include :: header"></head>
<body class="white-bg">
<div class="wrapper wrapper-content animated fadeInRight ibox-content">
    <form class="form-horizontal m" id="form-banner-add">
        <div class="form-group">
            <label class="col-sm-3 control-label ">名称：</label>
            <div class="col-sm-8">
                <input class="form-control" type="text" id="title" name="title"/>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">排序：</label>
            <div class="col-sm-8">
                <input class="form-control" type="text" id="sort" name="sort"/>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">APP跳转链接：</label>
            <div class="col-sm-8">
                <input class="form-control" type="text" name="appJumpUrl" id="appJumpUrl">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">WAP跳转链接：</label>
            <div class="col-sm-8">
                <input class="form-control" type="text" name="jumpUrl" id="jumpUrl">
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">Banner图片：</label>
            <div class="col-sm-8">
            	<div class="banner-box">
            		<input class="downloadPic" type="file" name="file" id="downloadPic" accept="image/*" >
            		<img class="banner-img" src="" alt="" id="bannerImgUrl">
            		<p class="add-img">+</p>
            	</div>
                <!-- <input class="form-control" type="text" name="pictureUrl" id="pictureUrl"> -->
                
            </div>
            <p class="col-sm-3 banner-size">700*300px</p>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">开始时间：</label>
            <div class="col-sm-8">
                <li class="select-time">
                    <input type="text" class="time-input" id="startTime" name="params[beginTime]"/>
                </li>
            </div>
        </div>
        <div class="form-group">
            <label class="col-sm-3 control-label">结束时间：</label>
            <div class="col-sm-8">
                <li class="select-time">
                    <input type="text" class="time-input" id="endTime" name="params[endTime]"/>
                </li>
            </div>
        </div>
    </form>
</div>
<div th:include="include::footer"></div>
<script th:src="@{/ajax/libs/select/select2.js}"></script>
<script>
	var isFirst = true; /* 首次执行提交 */
	layui.use('laydate', function(){
		var laydate = layui.laydate;
		/*var startTime = laydate.render({
		    elem: '#startTime',
		    type: 'datetime',
		    btns: ['now', 'confirm']
	    });
		var endTime = laydate.render({
		    elem: '#endTime',
		    type: 'datetime',
		    btns: ['now', 'confirm']
	    });*/

        var startDate = laydate.render({
            elem: '#startTime',
            min: Date.now(),
            type: 'datetime',
            done: function (value, date) {
                endDate.config.min = {
                    year: date.year,
                    month: date.month - 1,
                    date: date.date,
                };
                endDate.config.start = {
                    year: date.year,
                    month: date.month - 1,
                    date: date.date,
                };
            }
        });
        var endDate = laydate.render({
            elem: '#endTime',
            min: Date.now(),
            type: 'datetime',
            done: function (value, date) {
                startDate.config.max = {
                    year: date.year,
                    month: date.month - 1,
                    date: date.date,
                }
            }
        });
    });
    $("#form-banner-add").validate({
        rules: {
            title: {
                required: true
            },
            sort: {
                required: true
            },/*,
            appJumpUrl: {
                required: true
            },*/
            bannerImgUrl: {
                required: true
            }
        }
    });
    /* 图片在前端预览 */
    var pictureSuffix ="";
    var pictureBase64 = "";
    $("#downloadPic").change(function(e,type){
    	var files = e.target.files;
		var file = files[0];
		var fileSize = file.size;
		if (!/\/(?:jpeg|jpg|png)/i.test(file.type)){
			$.modal.alertError("上传图片格式只能为jpeg,jpg,png");
			return;
		}
		var reader = new FileReader();
		reader.onload = function() { 
			if(fileSize-0 > 1048576){
				$.modal.alertError("上传图片不能超过1M");
				return false;
			}
			var result = this.result;
			$("#bannerImgUrl").attr("src",result);
			/* console.log(result) */
			pictureSuffix = file.type.split("/")[1];
			pictureBase64 = result.split(",")[1];
			/* console.log(pictureSuffix,pictureBase64) */
		};
		reader.readAsDataURL(file);
    });
    function submitHandler() {
        if ($.validate.form()) {
        	if(isFirst){
        		add();
        	}
        }
    }
    function add() {
        var title = $("input[name='title']").val();
        var sort = $("input[name='sort']").val();
        var appJumpUrl = $("input[name='appJumpUrl']").val();
        var jumpUrl = $("input[name='jumpUrl']").val();
        var startTime = $("#startTime").val();
        var endTime = $("#endTime").val();
        $.ajax({
            cache: true,
            type: "POST",
            url: ctx + "content/banner/saveOrUpdate",
            data: {
                "title": title,
                "sort": sort,
                "status": 1,
                "appJumpUrl": appJumpUrl,
                "jumpUrl": jumpUrl,
                "startTime": startTime,
                "closeTime": endTime,
                "pictureSuffix":pictureSuffix,
                "pictureBase64":pictureBase64
               
            },
            async: false,
            error: function (request) {
                $.modal.alertError("系统错误");
            },
            success: function (data) {
            	isFirst = false;
                $.operate.saveSuccess(data);
            }
        });
    };

    function showMask() {
        $("#mask").css("height", $(document).height());
        $("#mask").css("width", $(document).width());
        $("#mask").show();

        $('#icon').addClass('fa fa-circle-o-notch fa-spin');
        $('#icon').parent().css("padding-top", $(document).height() / 3);
        $('#icon').parent().css("padding-left", $(document).width() / 2);
        $('#icon').parent().addClass('center-block');
        $("#icon").parent().show();
        setTimeout(hideMask, 5000);
    }
    //隐藏遮罩层
    function hideMask() {
        $("#mask").hide();
        $("#icon").parent().hide();
    }

</script>
</body>
</html>
