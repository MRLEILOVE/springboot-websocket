<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<meta charset="utf-8">
<style>
	input[name='textVal'],input[name='timeVal']{
		width:50px;
	}
	.unit li,.time li{
		margin-bottom:10px;
	}
</style>
<head th:include="include :: header"></head>
<body class="white-bg">
	<div class="wrapper wrapper-content animated fadeInRight ibox-content">
		<form class="form-horizontal m" id="form-perpetual-edit" th:object="${perpetual}">
			<input name="id"  type="hidden"  th:field="*{id}" />
			<div class="col-md-12">
				<div class="form-group">
					<label class="col-sm-3 control-label">交易对：</label>
					<div class="col-sm-8">
						<input type="text" name="" disabled="disabled" class="form-control" th:field="*{symbol}">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">杠杆：</label>
					<div class="col-sm-3">
						<input type="hidden" id="marginRatio" name="marginRatio" class="form-control" th:field="*{marginRatio}">
						<ul id="marginR" class="unit">

						</ul>
						<div><input id="addBtn" type="button" value="+" /></div>
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">最小手数：</label>
					<div class="col-sm-8">
						<input type="number" name="tradingUnitMin" class="input-val form-control" th:field="*{tradingUnitMin}">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">最大手数：</label>
					<div class="col-sm-8">
						<input type="number" name="tradingUnitMax" class="input-val form-control" th:field="*{tradingUnitMax}">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">开仓手续费率：</label>
					<div class="col-sm-8">
						<input type="number" name="serviceFee" class="input-val form-control" th:value="${#numbers.formatDecimal(perpetual.serviceFee*100,1,2)}">
					</div>
					<label class="control-label">%</label>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">平仓手续费率：</label>
					<div class="col-sm-8">
						<input type="number" name="closeFee" class="input-val form-control" th:value="${#numbers.formatDecimal(perpetual.closeFee*100,1,2)}">
					</div>
					<label class="control-label">%</label>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">买涨点差：</label>
					<div class="col-sm-8">
						<input type="number" name="spreadUp" class="input-val form-control" th:field="*{spreadUp}">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">买跌点差：</label>
					<div class="col-sm-8">
						<input type="number" name="spreadDown" class="input-val form-control" th:field="*{spreadDown}">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">体验金买涨点差：</label>
					<div class="col-sm-8">
						<input type="number" name="tokenSpreadUp" class="input-val form-control" th:field="*{tokenSpreadUp}">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">体验金买跌点差：</label>
					<div class="col-sm-8">
						<input type="number" name="tokenSpreadDown" class="input-val form-control" th:field="*{tokenSpreadDown}">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">平仓滑点：</label>
					<div class="col-sm-8">
						<input type="number" name="slippage" class="input-val form-control" th:field="*{slippage}">
					</div>
				</div>
				<div class="form-group">
					<label class="col-sm-3 control-label">点位盈亏：</label>
					<div class="col-sm-8">
						<input type="number" name="contractValue" class="input-val form-control" th:field="*{contractValue}">
					</div>
					<span style="display: inline-block;margin-top: 8px;">USDT</span>
				</div>
			</div>
		</form>
	</div>
	<div th:include="include::footer"></div>
	<script th:src="@{/ajax/libs/select/select2.js}"></script>
	<script>
        $("#form-perpetual-edit").validate({
        	submitHandler:function(form){
        		edit();
        	}
        });
        
        function submitHandler() {
	        if ($.validate.form()) {
	        	edit();
	        }
	    }

        function edit() {
            var nitArray =[];
            $("input[name='textVal']").each(function(){
                nitArray.push($(this).val());
            });
            /* 判断输入值是否符合要求 */
            for(let i = 0;i < $("input[name='textVal']").length;i++){
                if(nitArray[i] == ""||Number(nitArray[i]) < 0||nitArray[i].indexOf('.')!==-1){
                    $.modal.alertError("输入格式错误,请输入正整数");
                    return false;
                }
            }
            /* 输入框非空校验 */
        	for(let i = 0;i < $(".input-val").length;i++){
        		if($(".input-val").eq(i).val()==''){
        			$.modal.alertError("输入不能为空");
        			return false;
        		}
        	}

            var id = $("input[name='id']").val();
        	var tradingUnitMin = $("input[name='tradingUnitMin']").val();
        	var tradingUnitMax = $("input[name='tradingUnitMax']").val();
        	// var marginRatio = $("input[name='marginRatio']").val();
            var marginRatio = nitArray.join(",");
        	var serviceFee = $("input[name='serviceFee']").val();
        	var closeFee = $("input[name='closeFee']").val();
            var slippage = $("input[name='slippage']").val();
            var spreadUp = $("input[name='spreadUp']").val();
            var spreadDown = $("input[name='spreadDown']").val();
            var tokenSpreadUp = $("input[name='tokenSpreadUp']").val();
            var tokenSpreadDown = $("input[name='tokenSpreadDown']").val();
            var contractValue = $("input[name='contractValue']").val();
        	$.ajax({
        		cache : true,
        		type : "POST",
        		url : ctx + "product/perpetual/edit",
        		data : {
        			"id": id,
        			"tradingUnitMin": tradingUnitMin,
        			"tradingUnitMax": tradingUnitMax,
        			"marginRatio": marginRatio,
        			"serviceFee": serviceFee,
        			"closeFee": closeFee,
        			"slippage": slippage,
                    "spreadUp": spreadUp,
                    "spreadDown": spreadDown,
                    "tokenSpreadUp": tokenSpreadUp,
                    "tokenSpreadDown": tokenSpreadDown,
                    "contractValue": contractValue
        		},
        		async : false,
        		error : function(request) {
        			$.modal.alertError("系统错误");
        		},
        		success : function(data) {
        			$.operate.saveSuccess(data);
        		}
        	});
        }

        $(function(){
            var a = $("#marginRatio").val();
            var bzjVal = a.split(",");
            /* console.log(bzjVal); */
            var bzjList = '';

            /* 保证金创建空的栏目 */
            var addBzjList = `<li>
								<input type="number" name="textVal" value="" />
								<span>USDT</span>
								<input type="button" name="reduce" value="-" />
						   </li>`
            for(let i = 0;i < bzjVal.length;i++){
                bzjList += `<li>
								<input type="number" name="textVal" value="${bzjVal[i]}" />
								<span>USDT</span>
								<input type="button" name="reduce" value="-" />
						   </li>`
            }
            $("#marginR").append(bzjList);
            $(document).on("click","#addBtn",function(){
                $("#marginR").append(addBzjList);
            });
            $(document).on("click","input[name='reduce']",function(e){
                console.log(e.target.parentNode)
                $(this).parent().remove();
            });
        });
    </script>
</body>
</html>
